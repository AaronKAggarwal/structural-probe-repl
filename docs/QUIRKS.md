# Quirks, Surprises, and Workarounds (structural-probe-repl)

Last updated: 2025-05-26

This document lists non-obvious behaviors, unexpected issues, and their resolutions or important notes encountered during the project.

| Area                        | Symptom / Problem                                                                 | Workaround / Note / Lesson Learned                                                                                                                                                                 |
|-----------------------------|-----------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Docker & Platform**       |                                                                                   |                                                                                                                                                                                                    |
| Platform Mismatch           | Building for one architecture (e.g., `arm64` implicitly) and running with `--platform=linux/amd64`. | Docker may try to pull a non-existent variant or fail. Always ensure build platform matches run platform if specifying `--platform`.                                             |
| CPU Features (AVX)        | TensorFlow 1.15 `amd64` binary ran under QEMU (Apple Silicon) crashed.            | `Illegal instruction`. TF binary required AVX opcodes not fully emulated. (Moot after discovering legacy code is PyTorch, not TF).                                                                 |
| Dockerfile Comments         | Build errors like `lstat /#: no such file or directory` or `"/CHANGED": not found`. | Ensure comments (`#`) are cleanly separated from commands/paths. Avoid unusual characters. Docker's parser can be sensitive to comments on `COPY` or `RUN` lines if they seem to alter paths. |
| Nested `.git` Dirs          | `COPY path/to/dir/. .` failed with `cannot copy to non-directory: ... /.git`.     | Add the nested `.git` directory (e.g., `path/to/dir/.git`) to the root `.dockerignore` file to prevent it from being part of the Docker build context.                                             |
| **Dependencies (General)**  |                                                                                   |                                                                                                                                                                                                    |
| Poetry vs. Homebrew         | `poetry self add` (for plugins) fails if Poetry was installed via Homebrew.         | Homebrew-installed files can be immutable by user-level Poetry. Prefer `pipx install poetry` for user-space isolation. If needed, `brew uninstall poetry`.                                          |
| Pytest `ModuleNotFoundError`| Tests failing with `ModuleNotFoundError: No module named 'src'` or `No module named 'torch_probe'`. | Ensure `pyproject.toml` correctly defines `[tool.poetry.packages]` (e.g., `packages = [{include = "torch_probe", from = "src"}]`) and run `poetry install`. Alternatively, configure `pythonpath` in `pytest.ini` or `pyproject.toml [tool.pytest.ini_options]`. Use consistent import style (e.g., `from torch_probe...`). |
| **Dependencies (Legacy Container)** |                                                                           |                                                                                                                                                                                                    |
| PyTorch Wheel Availability  | `pip` couldn't find specific older PyTorch version strings like `1.1.0+cpu`.        | Check `pip`'s error output for *actually available* version strings (e.g., `1.3.0+cpu`). The `+cpu` or other metadata tags aren't uniform across all old versions for direct pip resolution.      |
| PyYAML API Change           | `yaml.load(stream)` caused `TypeError: load() missing 1 required positional argument: 'Loader'`. | Caused by PyYAML >= 5.1. Pin to an older version (e.g., `PyYAML==3.13`) in the legacy environment to use original H&M code as-is. Alternatively, modify code to `yaml.safe_load()` or `yaml.load(..., Loader=...)`. |
| AllenNLP 0.9.0 TypeErrors   | `TypeError: ArrayField.empty_field: return type \`None\` is not a Field`.           | Caused by incompatibility with newer `overrides` or `typing-extensions`. Pin `overrides==3.1.0` and `typing-extensions==3.7.4` for AllenNLP 0.9.0.                                                    |
| `tqdm` Python Compatibility | Newer `tqdm` versions may drop support for older Python (e.g., 3.6/3.7).          | If `No matching distribution found` for `tqdm`, check PyPI for the last version supporting the target Python and pin it (e.g., `tqdm==4.47.0` for Py3.7).                                           |
| NumPy Pin Drift (Legacy)    | PyTorch 1.3 wheels might be formally built against older NumPy (e.g., 1.16).      | `numpy==1.19.5` was found to work with PyTorch 1.3.0 and AllenNLP 0.9.0 in the legacy container and is acceptable.                                                                              |
| **Data & Code (General)**   |                                                                                   |                                                                                                                                                                                                    |
| Dead Download Links         | Original Hewitt & Manning `download_example.sh` script URLs return 404.           | Cannot download their pre-packaged example data. **Solution:** Sourced identical files (CoNLLU, ELMo HDF5, BERT `.params`) from the `whykay-01/structural-probes` GitHub fork for Phase 0a. |
| Relative Paths in Code      | Scripts expect to run from project root; fail if `WORKDIR` isn't set correctly (Docker) or script CWD changes (Hydra). | **Docker:** Set `WORKDIR` appropriately. **Hydra:** Use `hydra.utils.get_original_cwd()` to resolve paths in config relative to where the script was launched, as Hydra changes CWD to its output dir. |
| Shebang Typos               | `/binbash` instead of `#!/bin/bash`.                                               | Scripts fail with `bad interpreter`. Double-check shebang lines.                                                                                                                                   |
| CoNLLU MWT vs Embedding Tokens | `AssertionError` in data loading due to token count mismatch.                     | **Legacy (Phase 0a):** H&M original `data.py` counted MWTs; their ELMo HDF5s (via `whykay-01`) were consistent. **Modern (Phase 1):** Our `conllu_reader.py` filters MWTs (counts syntactic tokens). ELMo HDF5s for modern probe must be generated using raw text derived from this MWT-filtered tokenization to ensure alignment. |
| H&M Script Differentiation  | `run_experiment.py` vs. `run_demo.py`.                                            | `demo-bert.yaml` is for `run_demo.py` (inference). Other configs are for `run_experiment.py` (training). Wrapper script (`run_legacy_probe.sh`) updated to select correct Python script. |
| **Hydra Configuration**     |                                                                                   |                                                                                                                                                                                                    |
| Override Errors             | `Could not override 'X'. No match in the defaults list.` or `X@Y.Z` errors.       | Ensure the main `config.yaml` has the group (e.g., `dataset`) in its `defaults` list. Ensure experiment configs use simple `override /group: choice` syntax without unintended `@` symbols. Double-check for typos/syntax errors in all composed YAML files. Clearing `outputs/` can sometimes help with stale Hydra states. |
| Output Directory Control    | `train_probe.py` (when run via `subprocess` in tests) writing to project root instead of Hydra's specified `run.dir`. | `Path.cwd()` in a Hydra-decorated script *is* the unique output dir. The issue was the smoke test's assertion path. Corrected smoke test to check the appropriate Hydra output path structure or (pragmatically) the observed output path and clean up. |
| **Native macOS Env**        |                                                                                   |                                                                                                                                                                                                    |
| NumPy vs. PyTorch (Native)| `numpy>=2.0` can break `torch<=2.2.x` due to API changes.                         | Pin `numpy<2.0` (e.g., `numpy~=1.26.4`) in the native environment using PyTorch 2.2. This is a mandatory pin.                                                                    |
| Python Version for Torch    | Newer PyTorch versions have minimum Python requirements.                            | PyTorch 2.2 requires Python >=3.8, <=3.11 (as of early 2024).                                                                                                                                      |
| `tokenizers` Build          | `tokenizers` package may require Rust compiler if installing from `sdist` on `arm64`. | Install Rust toolchain (`brew install rust`) on macOS for native environment setup.                                                                                                    |