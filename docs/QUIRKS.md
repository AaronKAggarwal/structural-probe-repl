# Quirks, Surprises, and Workarounds (structural-probe-repl)

Last updated: 2025-05-07

This document lists non-obvious behaviors, unexpected issues, and their resolutions or important notes encountered during the project.

| Area                        | Symptom / Problem                                                                 | Workaround / Note / Lesson Learned                                                                                                                              |
|-----------------------------|-----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Docker & Platform**       |                                                                                   |                                                                                                                                                                 |
| Platform Mismatch           | Building for one architecture (e.g., `arm64` implicitly) and running with `--platform=linux/amd64`. | Docker may try to pull a non-existent variant or fail. Always ensure build platform matches run platform if specifying `--platform`.                          |
| CPU Features (AVX)        | TensorFlow 1.15 `amd64` binary ran under QEMU (Apple Silicon) crashed.            | `Illegal instruction`. TF binary required AVX opcodes not fully emulated. (Moot after discovering legacy code is PyTorch, not TF).                              |
| Dockerfile Comments         | Build errors like `lstat /#: no such file or directory` or `"/CHANGED": not found`. | Ensure comments (`#`) are cleanly separated from commands/paths. Avoid unusual characters. Docker's parser can be sensitive to comments on `COPY` or `RUN` lines. |
| Nested `.git` Dirs          | `COPY path/to/dir/. .` failed with `cannot copy to non-directory: ... /.git`.     | Add the nested `.git` directory (e.g., `path/to/dir/.git`) to the root `.dockerignore` file to prevent it from being part of the Docker build context.         |
| **Dependencies (General)**  |                                                                                   |                                                                                                                                                                 |
| Poetry vs. Homebrew         | `poetry self add` (for plugins) fails if Poetry was installed via Homebrew.         | Homebrew-installed files can be immutable by user-level Poetry. Prefer `pipx install poetry` for user-space isolation. If needed, `brew uninstall poetry`.      |
| **Dependencies (Legacy Container)** |                                                                           |                                                                                                                                                                 |
| PyTorch Wheel Availability  | `pip` couldn't find specific older PyTorch version strings like `1.1.0+cpu`.        | Check `pip`'s error output for *actually available* version strings (e.g., `1.3.0+cpu`). The `+cpu` or other metadata tags aren't uniform across all old versions. |
| PyYAML API Change           | `yaml.load(stream)` caused `TypeError: load() missing 1 required positional argument: 'Loader'`. | Caused by PyYAML >= 5.1. Pin to an older version (e.g., `PyYAML==3.13`) in the legacy environment.                                                              |
| AllenNLP 0.9.0 TypeErrors   | `TypeError: ArrayField.empty_field: return type \`None\` is not a Field`.           | Caused by incompatibility with newer `overrides` or `typing-extensions`. Pin `overrides==3.1.0` and `typing-extensions==3.7.4` for AllenNLP 0.9.0.                |
| `tqdm` Python Compatibility | Newer `tqdm` versions may drop support for older Python (e.g., 3.6/3.7).          | If `No matching distribution found` for `tqdm`, check PyPI for the last version supporting the target Python and pin it (e.g., `tqdm==4.47.0` for Py3.7).       |
| NumPy Pin Drift (Legacy)    | PyTorch 1.3 wheels might be formally built against older NumPy (e.g., 1.16).      | `numpy==1.19.5` was found to work with PyTorch 1.3.0 and AllenNLP 0.9.0 in the legacy container. This is acceptable.                                          |
| **Data & Code (Legacy)**    |                                                                                   |                                                                                                                                                                 |
| Dead Download Links         | Original Hewitt & Manning `download_example.sh` script URLs return 404.           | Cannot download their pre-packaged example data. Solution: Recreate a sample from UD EWT (GitHub) and generate ELMo HDF5 embeddings locally.                  |
| Relative Paths in Code      | Scripts expect to run from project root; fail if `WORKDIR` isn't set correctly.   | Set `WORKDIR` in Dockerfile appropriately (e.g., to the root of the copied legacy code). Ensure scripts and config files use paths relative to this `WORKDIR`. |
| Shebang Typos               | `/binbash` instead of `#!/bin/bash`.                                               | Scripts fail with `bad interpreter`. Double-check shebang lines.                                                                                                |
| CoNLLU MWT vs ELMo Tokens   | `AssertionError` in `data.py` due to token count mismatch.                        | H&M `data.py`'s `load_conll_dataset` counted MWT surface forms; ELMo tokenized underlying syntactic units. Fix: Modified `load_conll_dataset` to filter MWTs. |
| **Native macOS Env**        |                                                                                   |                                                                                                                                                                 |
| NumPy vs. PyTorch (Native)| `numpy>=2.0` can break `torch<=2.2.x` due to API changes.                         | Pin `numpy<2.0` (e.g., `numpy~=1.26.4`) in the native environment using PyTorch 2.2. This is a mandatory pin.                                                 |
| Python Version for Torch    | Newer PyTorch versions have minimum Python requirements.                            | PyTorch 2.2 requires Python >=3.8, <=3.11 (as of early 2024).                                                                                                   |
| `tokenizers` Build          | `tokenizers` package may require Rust compiler if installing from `sdist` on `arm64`. | Install Rust toolchain (`brew install rust`) on macOS for native environment setup.                                                                               |