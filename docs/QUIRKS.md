# Quirks, Surprises, and Workarounds (structural-probe-repl)

Last updated: 2025-05-26

This document lists non-obvious behaviors, unexpected issues, and their resolutions or important notes encountered during the project. This helps newcomers understand design choices and past challenges.

| Area                        | Symptom / Problem                                                                 | Workaround / Note / Lesson Learned                                                                                                                                                                 |
|-----------------------------|-----------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Docker & Platform**       |                                                                                   |                                                                                                                                                                                                    |
| Platform Mismatch           | Building for one architecture (e.g., `arm64` implicitly) and running with `--platform=linux/amd64`. | Docker may try to pull a non-existent variant or fail. Always ensure build platform matches run platform if specifying `--platform`.                                             |
| CPU Features (AVX)        | TensorFlow 1.15 `amd64` binary ran under QEMU (Apple Silicon) crashed.            | `Illegal instruction`. TF binary required AVX opcodes not fully emulated. (This became moot after discovering the legacy H&M code is PyTorch-based, not TensorFlow).                                   |
| Dockerfile Comments         | Build errors like `lstat /#: no such file or directory` or `"/CHANGED": not found` on `COPY` or `RUN` lines. | Ensure comments (`#`) are cleanly separated from commands/paths by standard spaces. Avoid unusual characters or placing comments mid-command. Docker's parser can be sensitive. |
| Nested `.git` Dirs          | `COPY path/to/dir/. .` failed with `cannot copy to non-directory: ... /.git`.     | If vendoring external code that was a Git repository, its internal `.git` directory will cause issues with `COPY . .`. Add the nested `.git` (e.g., `src/legacy/structural_probe/.git`) to the root `.dockerignore` file. |
| **Dependencies (General)**  |                                                                                   |                                                                                                                                                                                                    |
| Poetry vs. Homebrew         | `poetry self add` (for plugins) fails if Poetry was installed via Homebrew.         | Homebrew-installed files can be immutable by user-level Poetry. Prefer `pipx install poetry` for user-space isolation. If Homebrew Poetry exists, `brew uninstall poetry` first.             |
| Pytest `ModuleNotFoundError`| Tests failing with `ModuleNotFoundError: No module named 'src'` or `No module named 'torch_probe'`. | Ensure `pyproject.toml` correctly defines `[tool.poetry.packages]` (e.g., `packages = [{include = "torch_probe", from = "src"}]`) and run `poetry install`. Alternatively, configure `pythonpath = ["src", "."]` in `pyproject.toml [tool.pytest.ini_options]` to allow `from src...` imports in tests. Use consistent import styles. |
| **Dependencies (Legacy Container - `probe:legacy_pt_cpu`)** |                                                                   |                                                                                                                                                                                                    |
| PyTorch Wheel Availability  | `pip` couldn't find specific older PyTorch version strings like `1.1.0+cpu`.        | Check `pip`'s error output for *actually available* version strings (e.g., `1.3.0+cpu`). The `+cpu` or other metadata tags aren't uniform across all old versions for direct `pip` resolution via the simple index. Using PyTorch's wheel archive URL (`-f https://download.pytorch.org/whl/torch_stable.html`) is more reliable for older versions. |
| PyYAML API Change           | `yaml.load(stream)` caused `TypeError: load() missing 1 required positional argument: 'Loader'`. | Caused by PyYAML >= 5.1. For the legacy H&M code, pinned to an older version (`PyYAML==3.13`) in the Docker environment to maintain original code compatibility. (Alternative for new code: use `yaml.safe_load()` or `yaml.load(..., Loader=yaml.FullLoader)`). |
| AllenNLP 0.9.0 TypeErrors   | `TypeError: ArrayField.empty_field: return type \`None\` is not a Field`.           | Caused by incompatibility of AllenNLP 0.9.0 with newer transitive dependencies like `overrides` or `typing-extensions`. Pinned `overrides==3.1.0` and `typing-extensions==3.7.4` in the legacy Dockerfile. |
| `tqdm` Python Compatibility | Newer `tqdm` versions may drop support for older Python (e.g., 3.6/3.7).          | If `No matching distribution found` for `tqdm` during `pip install`, check PyPI for the last version supporting the target Python and pin it (e.g., `tqdm==4.47.0` for Python 3.7).       |
| NumPy Pin Drift (Legacy)    | PyTorch 1.3 wheels might be formally built against older NumPy (e.g., 1.16).      | `numpy==1.19.5` was found to work well with PyTorch 1.3.0 and AllenNLP 0.9.0 in the legacy container and is acceptable.                                                                              |
| **Data & Code (General & Legacy)**    |                                                                           |                                                                                                                                                                                                    |
| Dead Download Links (H&M)   | Original Hewitt & Manning `download_example.sh` script URLs for sample data and pre-trained BERT probes return 404. | Cannot download their pre-packaged example artifacts. **Solution for Phase 0a:** Sourced identical/equivalent files (CoNLLU, ELMo HDF5, BERT `.params`) from the `whykay-01/structural-probes` GitHub fork. |
| Relative Paths in Code      | Scripts using relative paths may fail if `WORKDIR` (Docker) or current working directory (Hydra) isn't the expected project root. | **Docker:** Set `WORKDIR` appropriately in the Dockerfile. **Hydra:** Hydra changes CWD to its unique output directory. Use `hydra.utils.get_original_cwd()` in Python scripts to resolve paths originally relative to where the script was launched. |
| Shebang Typos               | `/binbash` instead of `#!/bin/bash` in shell scripts.                              | Scripts fail with `bad interpreter`. Proofread shebang lines carefully.                                                                                                                      |
| CoNLLU MWT vs Embedding Tokens | `AssertionError` in data loading due to token count mismatch.                     | **Legacy (Phase 0a):** H&M original `data.py` counted MWT surface forms; their ELMo HDF5s (via `whykay-01`) were consistent with this. **Modern (Phase 1):** Our new `conllu_reader.py` filters MWTs (counts syntactic tokens). ELMo HDF5s for the modern probe *must be generated using raw text derived from this MWT-filtered tokenization* to ensure alignment. The modern `ProbeDataset` enforces this. |
| H&M Script Differentiation  | `run_experiment.py` vs. `run_demo.py`.                                            | `demo-bert.yaml` is for `run_demo.py` (inference with pre-trained probes). Other configs (e.g., `prd_en_ewt-ud-sample.yaml`) are for `run_experiment.py` (training). The wrapper script `scripts/run_legacy_probe.sh` was updated to detect the config and call the appropriate H&M Python script. |
| **Hydra Configuration**     |                                                                                   |                                                                                                                                                                                                    |
| Override Errors             | `Could not override 'X'. No match in the defaults list.` or `X@Y.Z` errors when composing configs. | Usually indicates an issue with the `defaults` list in the main `config.yaml` (a group not declared) or the experiment file (incorrect `override /group: choice` syntax, or a typo like an unintended `@`). Ensure all composed config group files (`dataset/*.yaml`, etc.) are simple key-value structures. Clearing `outputs/` and `multirun/` can sometimes help with stale Hydra states during debugging. |
| Output Directory for Subprocess | `scripts/train_probe.py` (when run via `subprocess` in smoke tests) defaulted to writing outputs in project root, not respecting Hydra's `run.dir` override passed via CLI to `subprocess`. | Hydra's CWD management is complex for subprocesses. The smoke test was adapted to check for outputs in the project root and clean them up. For regular runs, `hydra.run.dir` (if set) or Hydra's default date-time output structure works as expected. |                                                                |
| Interpolation Failure   | `omegaconf.errors.InterpolationKeyError: Interpolation key 'experiment.name' not found` when setting `hydra.run.dir`.      | This occurs when an experiment file is loaded that is missing a top-level `name:` key. **Solution:** Enforce a strict convention where every `.yaml` file inside `configs/experiment/` must define a `name` key, which is then used by `${experiment.name}` in the main `config.yaml`.                                                                                                                                                                                                            |
| Override Conflicts      | `Could not append to config. An item is already at '...'` when using a `+key=value` override on the command line.          | This error means you are trying to **add** a key that already exists in the composed configuration (e.g., it was defined in a default YAML). **Solution:** To simply change an existing key's value, remove the `+` prefix (e.g., `key=value`). To robustly **add or override**, use the `++` prefix (e.g., `++key=value`). The `++` syntax is extremely useful in test scripts that operate on multiple base configs, some of which may not define the key being overridden. |

| **Training Regimen (Modern vs. H&M Legacy)** |                                                                   |                                                                                                                                                                                                    |
| Optimizer Reset & LR Decay  | H&M Appendix A.2 describes a specific optimizer reset and LR decay schedule if dev loss plateaus. | Our modern `scripts/train_probe.py` now implements a similar mechanism (`LRSchedulerWithOptimizerReset` in `train_utils.py`), configurable via `configs/training/*.yaml` under `lr_scheduler_with_reset`. This differs from standard PyTorch LR schedulers. |
| **Native macOS Env**        |                                                                                   |                                                                                                                                                                                                    |
| NumPy vs. PyTorch (Native)| `numpy>=2.0` can break `torch<=2.2.x` due to API changes.                         | Pin `numpy<2.0` (e.g., `numpy~=1.26.4`) in the native Poetry environment when using PyTorch 2.2. This is a mandatory pin.                                                              |
| Python Version for Torch    | Newer PyTorch versions have minimum Python requirements.                            | PyTorch 2.2.x requires Python >=3.8, <=3.11 (as of its release). Poetry manages this.                                                                                                      |
| `tokenizers` Build (macOS)  | `tokenizers` package (from Hugging Face) may require Rust compiler if installing from `sdist` on `arm64` (Apple Silicon). | Install Rust toolchain (e.g., via `brew install rust`) on macOS for the native development environment.                                                                        |

| **Metric Calculation**  |                                                                                   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Spearman Filtering      | `spearmanr_hm` metric differs between the original H&M code and a strict reading of the paper. | The paper describes filtering for sentences of length 5-50. The reference code implements this by filtering on the **original, punctuation-inclusive length**. Our modern `evaluate.py` implementation initially filtered by **non-punctuation length**, which is more linguistically sound but produces slightly different results. **Solution:** Added a boolean config key `evaluation.filter_by_non_punct_len`. Set to `false` for perfect replication of the original code's metric, `true` (default) for the more robust method. |
| Punctuation Tags        | The original code uses PTB-style XPOS tags to filter punctuation for UUAS/RootAcc. | This is not generalizable to all UD treebanks. **Solution:** Added a string config key `evaluation.punctuation_strategy` which can be `'xpos'` (for H&M replication) or `'upos'` (default, for new experiments). This allows for consistent cross-linguistic evaluation using the universal `PUNCT` and `SYM` tags.                                                                                                                                                                            |