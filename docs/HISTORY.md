# Build / Debug History (structural-probe-repl)

Last updated: 2025-05-23

This document tracks significant milestones, challenges, and resolutions encountered during the setup and development of the project environments, particularly for the legacy probe replication.

| Date (2025) | Milestone / Task                      | Key Challenge(s) / Discovery                                                                  | Outcome / Fix / Decision                                                                                                                                  |
|-------------|---------------------------------------|-----------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| May 02      | Native Env Setup (Poetry)             | `poetry self add poetry-plugin-export` failed with Homebrew-installed Poetry.                 | Unlinkable brew files. Re-installed Poetry via `pipx` for user-space isolation; plugin installed cleanly.                                                 |
| May 02      | Initial Legacy Env Plan (Assumed TF1) | Project README for H&M code was not yet consulted.                                            | Initial plan assumed TensorFlow 1.x for legacy probe based on age of paper.                                                                               |
| May 06      | Docker Build (TF1 Attempt)            | TF1.15 `amd64` binary (with AVX) failed on Apple Silicon (M3) under QEMU Rosetta 2 emulation.  | `Illegal instruction` error. Confirmed AVX issue. (Moot after discovering H&M code is PyTorch).                                                              |
| May 06      | H&M Code Review                       | GitHub README for `john-hewitt/structural-probes` reviewed.                                   | **Critical Discovery:** Original H&M code is PyTorch-based (~v1.0-1.3), not TensorFlow.                                                                    |
| May 06      | Strategy Pivot (Legacy Probe)         | Need for TF1 environment eliminated.                                                          | Switched plan to target a PyTorch 1.x CPU environment for `linux/amd64`.                                                                                  |
| May 06      | Docker Base Image Search (PT 1.x)     | Difficulty finding official `pytorch/pytorch` tags explicitly named `X.Y.Z-cpu-py37`.         | Decided to use `python:3.7-slim-buster` as base and install PyTorch 1.x via `pip`.                                                                          |
| May 06      | Docker Build (PT 1.x - Iteration 1)   | `pip install torch==1.1.0+cpu` failed.                                                        | `No matching distribution found`. Pip's available version list showed `1.3.0+cpu` was available.                                                            |
| May 06      | Docker Build (PT 1.x - Iteration 2)   | `pip install torch==1.3.0+cpu` & `torchvision==0.4.1+cpu`. `numpy` pinned to `1.19.5`.         | **Build Succeeded.** Correct PyTorch/Torchvision versions found. Noted `numpy 1.19.5` works despite PT 1.3 wheels possibly built against older NumPy.    |
| May 06      | Container Run (Shebang Error)         | `scripts/run_legacy_probe.sh` failed.                                                         | `/binbash: bad interpreter`. Shebang typo. Corrected to `#!/bin/bash`. Rebuilt.                                                                           |
| May 06      | Container Run (Arg Passing)           | `run_legacy_probe.sh` passed args incorrectly to H&M script.                                  | Revised `run_legacy_probe.sh` logic and Dockerfile `CMD` to pass config file path directly. Rebuilt.                                                        |
| May 06      | Container Run (Config Path)           | H&M script: `Config file not found ... en_ewt-ud-sample.yaml`.                                | Default config path in `CMD` was incorrect. Corrected to `prd_en_ewt-ud-sample.yaml`. Rebuilt.                                                               |
| May 06      | Container Run (PyYAML API)            | `PyYAML` version installed by `pip` requires `Loader` argument for `yaml.load()`.             | Pinned `PyYAML==3.13` in Dockerfile `pip install`. Rebuilt.                                                                                               |
| May 07      | Container Run (AllenNLP TypeError)    | `TypeError: ArrayField.empty_field: return type \`None\` is not a Field`.                     | Caused by incompatibility with newer `overrides` or `typing-extensions`. Pinned `overrides==3.1.0` and `typing-extensions==3.7.4` in Dockerfile. Rebuilt. |
| May 07      | Docker Build (`WORKDIR` & Paths)      | Relative paths in H&M code not resolving from Docker `WORKDIR /workspace`.                    | Changed `WORKDIR` to `/app/structural_probe_original`, updated `COPY` paths, script paths in `ENTRYPOINT`/`CMD`, and internal script logic. Rebuilt.  |
| May 07      | Docker Build (`COPY` Path/Comment Errors)| Series of `COPY` failures (`/CHANGED` not found, nested `.git`, `lstat /#:`)                  | Cleaned comments on `COPY` lines. Added `src/legacy/structural_probe/.git` to `.dockerignore`. Rebuilt successfully.                                |
| May 07      | ELMo HDF5 Generation (Self-Prepared)  | Original H&M `download_example.sh` URLs dead. Sample data needed.                             | Created scripts to sample UD EWT CoNLLU, convert to raw text, generate ELMo HDF5s using AllenNLP 0.9.0 in `probe:legacy_pt_cpu` container. HDF5s generated. |
| May 07      | Legacy Run (Self-Prepared Data)       | `AssertionError` in `data.py` (CoNLLU MWTs vs ELMo tokens).                                   | Modified `load_conll_dataset` in `data.py` to filter MWTs. Rebuilt image with copied self-prepared sample data.                                        |
| May 07      | **Legacy ELMo Probe Run (Self-Data)** | Container ran H&M `run_experiment.py` on self-prepared sample.                                | Produced plausible UUAS (~0.26) and Spearman Rho (~0.42 for distance; ~0.16 for depth). Validated pipeline.                                           |
| May 23      | Discovered `whykay-01` Fork           | Found fork containing original H&M example data files (CoNLLU, ELMo HDF5, BERT `.params`).   | Strategy: Use these files for more direct example replication.                                                                                            |
| May 23      | Integrate `whykay-01` Data            | Downloaded files from fork into `src/legacy/structural_probe/example/data/`. Dockerfile updated to `COPY` this data. | `data_staging` sample data no longer copied into image.                                                                                                 |
| May 23      | Test with Original `data.py`          | `AssertionError` with modified `data.py` and `whykay-01` ELMo HDF5s.                          | Reverted `data.py` to original H&M version. Rebuilt image.                                                                                              |
| May 23      | **Legacy ELMo Run (whykay-01 Data)**  | Ran ELMo example using `whykay-01` data and original H&M `data.py`.                           | **Success!** No `AssertionError`. UUAS ~0.271, Spearman ~0.451. Confirmed consistency of original data & code.                                      |
| May 23      | Legacy BERT Demo Setup                | `run_legacy_probe.sh` was only calling `run_experiment.py`.                                   | Modified `run_legacy_probe.sh` to detect `demo-bert.yaml` and call `run_demo.py` instead. Rebuilt.                                                      |
| May 23      | **Legacy BERT Demo Run (whykay-01 Data)**| Ran BERT demo with `whykay-01` `.params` files.                                             | **Success!** Demo ran, loaded pre-trained probes, processed input, produced visualizations.                                                             |
| May 23      | **Phase 0a: Legacy Setup & Verification** | All H&M examples (ELMo training, BERT demo) now functional using data from `whykay-01` fork. | **COMPLETE.** Ready for Phase 1.                                                                                                                      |

(This history will be appended as the project progresses.)