# Build / Debug History (structural-probe-repl)

Last updated: 2025-05-07

This document tracks significant milestones, challenges, and resolutions encountered during the setup and development of the project environments, particularly for the legacy probe replication.

| Date (2025) | Milestone / Task                      | Key Challenge(s) / Discovery                                                                 | Outcome / Fix / Decision                                                                                                                               |
|-------------|---------------------------------------|----------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------|
| May 02      | Native Env Setup (Poetry)             | `poetry self add poetry-plugin-export` failed with Homebrew-installed Poetry.                | Unlinkable brew files. Re-installed Poetry via `pipx` for user-space isolation; plugin installed cleanly.                                              |
| May 02      | Initial Legacy Env Plan (Assumed TF1) | Project README for H&M code was not yet consulted.                                           | Initial plan assumed TensorFlow 1.x for legacy probe based on age of paper.                                                                            |
| May 06      | Docker Build (TF1 Attempt)            | TF1.15 `amd64` binary (with AVX) failed on Apple Silicon (M3) under QEMU Rosetta 2 emulation. | `Illegal instruction` error. Confirmed AVX issue.                                                                                                      |
| May 06      | H&M Code Review                       | GitHub README for `john-hewitt/structural-probes` reviewed.                                  | **Critical Discovery:** Original H&M code is PyTorch-based (~v1.0-1.3), not TensorFlow.                                                                 |
| May 06      | Strategy Pivot (Legacy Probe)         | Need for TF1 environment eliminated.                                                         | Switched plan to target a PyTorch 1.x CPU environment for `linux/amd64`.                                                                               |
| May 06      | Docker Base Image Search (PT 1.x)     | Difficulty finding official `pytorch/pytorch` tags explicitly named `X.Y.Z-cpu-py37`.        | Decided to use `python:3.7-slim-buster` as base and install PyTorch 1.x via `pip`.                                                                       |
| May 06      | Docker Build (PT 1.x - Iteration 1)   | `pip install torch==1.1.0+cpu` failed.                                                       | `No matching distribution found`. Pip's available version list showed `1.3.0+cpu` was available.                                                         |
| May 06      | Docker Build (PT 1.x - Iteration 2)   | `pip install torch==1.3.0+cpu` & `torchvision==0.4.1+cpu`. `numpy` pinned to `1.19.5`.        | **Build Succeeded.** Correct PyTorch/Torchvision versions found. Noted `numpy 1.19.5` works despite PT 1.3 wheels possibly built against older NumPy. |
| May 06      | Container Run (Shebang Error)         | `scripts/run_legacy_probe.sh` failed.                                                        | `/binbash: bad interpreter`. Shebang typo.                                                                                                             |
| May 06      | Container Run (Fix Shebang)           | Corrected shebang to `#!/bin/bash`. Rebuilt image.                                            | `run_legacy_probe.sh` executed, but H&M script `run_experiment.py` reported arg error.                                                                 |
| May 06      | Container Run (Arg Passing)           | `run_legacy_probe.sh` passed args incorrectly to H&M script.                                 | Revised `run_legacy_probe.sh` logic and Dockerfile `CMD` to pass config file path directly. Rebuilt.                                                     |
| May 06      | Container Run (Config Path)           | H&M script: `Config file not found ... en_ewt-ud-sample.yaml`.                               | Default config path in `CMD` was incorrect.                                                                                                            |
| May 06      | Container Run (Fix Config Path)       | Corrected `CMD` and default in `run_legacy_probe.sh` to use `prd_en_ewt-ud-sample.yaml`. Rebuilt. | H&M script now found config but failed: `TypeError: yaml.load() missing Loader`.                                                                       |
| May 06      | Container Run (PyYAML API)            | `PyYAML` version installed by `pip` requires `Loader` argument for `yaml.load()`.            | Pinned `PyYAML==3.13` in Dockerfile `pip install`. Rebuilt.                                                                                            |
| May 06      | Docker Build (`WORKDIR` & Paths)      | Relative paths in H&M code not resolving from Docker `WORKDIR /workspace`.                   | Changed `WORKDIR` to `/app/structural_probe_original`, updated `COPY` paths, script paths in `ENTRYPOINT`/`CMD`, and internal script logic. Rebuilt.     |
| May 06      | Docker Build (`COPY` Comment/Path Errors) | Series of `COPY` failures (`/CHANGED` not found, nested `.git`, `lstat /#:`)                 | Cleaned comments on `COPY` lines. Added `src/legacy/structural_probe/.git` to `.dockerignore`. Rebuilt successfully.                                   |
| May 06      | **Legacy Container Operational (Env)**| Docker image `probe:legacy_pt_cpu` builds. Health check passes. `run_experiment.py` starts.  | Fails on `FileNotFoundError` for HDF5 data (e.g., `en_ewt-ud-train.elmo-layers.hdf5`) due to dead `download_example.sh` URLs. Plan to create sample data. |

| May 07      | ELMo HDF5 Generation                  | Original H&M `download_example.sh` URLs dead. Sample data needed for legacy probe example.    | Created scripts to sample UD EWT CoNLLU, convert to raw text, generate ELMo HDF5s using AllenNLP 0.9.0 in `probe:legacy_pt_cpu` container. HDF5s generated. |
| May 07      | Legacy Container (Data Load Error)    | `AssertionError` in `data.py` due to token count mismatch (CoNLLU MWTs vs ELMo).            | Modified `load_conll_dataset` in H&M's `data.py` to filter MWT lines, aligning token counts. Rebuilt image with copied sample data.                            |
| May 07      | **Phase 0a: Legacy Probe Example Run**| Container `probe:legacy_pt_cpu` successfully ran H&M `run_experiment.py` on sample data.      | Produced plausible UUAS (~0.26) and Spearman Rho (~0.42 for distance; ~0.16 for depth) on dev set. **Phase 0a primary goal achieved.**       

(This history will be appended as the project progresses.)