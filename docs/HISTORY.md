# Build / Debug History (structural-probe-repl)

Last updated: 2025-05-26

This document tracks significant milestones, challenges, and resolutions encountered during the setup and development of the project environments and codebase.

| Date (2025) | Phase / Milestone / Task                  | Key Challenge(s) / Discovery                                                                  | Outcome / Fix / Decision                                                                                                                                                                 |
|-------------|-------------------------------------------|-----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Phase 0: Environment Setup & Legacy Probe Replication** |                                                                                               |                                                                                                                                                                              |
| May 02      | Native Env Setup (Poetry)                 | `poetry self add poetry-plugin-export` failed with Homebrew-installed Poetry.                 | Unlinkable brew files. Re-installed Poetry via `pipx` for user-space isolation; plugin installed cleanly.                                                                  |
| May 02      | Initial Legacy Env Plan (Assumed TF1)     | Project README for H&M code was not yet consulted.                                            | Initial plan assumed TensorFlow 1.x for legacy probe.                                                                                                                      |
| May 06      | Docker Build (TF1 Attempt)                | TF1.15 `amd64` binary (AVX) failed on Apple Silicon (M3) via Rosetta 2.                       | `Illegal instruction`. Confirmed AVX issue.                                                                                                                                |
| May 06      | H&M Code Review                           | GitHub README for `john-hewitt/structural-probes` reviewed.                                   | **Critical Discovery:** Original H&M code is PyTorch-based (~v1.0-1.3), not TensorFlow.                                                                                     |
| May 06      | Strategy Pivot (Legacy Probe)             | Need for TF1 environment eliminated.                                                          | Switched plan to target a PyTorch 1.x CPU environment (`linux/amd64`) for legacy code.                                                                                       |
| May 06      | Docker Base Image (Legacy PT)             | Difficulty finding specific `pytorch/pytorch:X.Y.Z-cpu-py37` tags.                            | Decided to use `python:3.7-slim-buster` as base and install PyTorch 1.x + dependencies via `pip`.                                                                          |
| May 06      | Docker Build (Legacy PT - Iteration 1)    | `pip install torch==1.1.0+cpu` failed.                                                        | `No matching distribution`. `pip` listed `1.3.0+cpu` as available.                                                                                                         |
| May 06      | Docker Build (Legacy PT - Iteration 2)    | Installed `torch==1.3.0+cpu`, `torchvision==0.4.1+cpu`, `numpy==1.19.5`, etc.                 | **Build Succeeded.** Core legacy dependencies installed.                                                                                                                   |
| May 06-07   | Legacy Container Runtime Debug            | Shebang typos, script arg passing errors, incorrect config paths, `PyYAML` API change, AllenNLP `TypeError` (`ArrayField`), Docker `WORKDIR`/`COPY` path issues, nested `.git` in `COPY`, Docker comment parsing. | Iteratively fixed scripts, Dockerfile, pinned `PyYAML==3.13`, `overrides==3.1.0`, `typing-extensions==3.7.4`. Used `.dockerignore`. Environment stabilized.               |
| May 07-23   | Legacy Example Data Handling              | H&M `download_example.sh` URLs dead. Initial self-prepared ELMo HDF5s caused `AssertionError` with original H&M `data.py` due to MWT counting. | Discovered `whykay-01` fork with original H&M sample data (CoNLLU, ELMo HDF5, BERT `.params`). Reverted `data.py` to original H&M version. Updated Dockerfile to `COPY` sourced data. |
| May 23      | **Phase 0a: Legacy Env & Examples**       | All H&M examples (ELMo training, BERT demo) now functional using data from `whykay-01` fork and original H&M `data.py`. | **COMPLETE.** Legacy probe pipeline verified. UUAS ~0.27 (ELMo dist), Spearman ~0.45 (ELMo dist), RootAcc ~0.08 (ELMo depth), BERT demo visualizations generated. |
| **Phase 1: Modern PyTorch Probe Re-implementation** |                                                                                               |                                                                                                                                                                              |
| May 23      | MS1.0: Basic Data Utilities               | -                                                                                             | Implemented `conllu_reader.py` (MWT-filtering) & `gold_labels.py` (depths/distances). Unit tests (own + independent) pass.                                                |
| May 24      | MS1.1: PyTorch Dataset & DataLoader     | Initial `pytest` `ModuleNotFoundError`. Mismatches in independent tests (HDF5 shape, head indexing, empty batch). | Fixed `pyproject.toml` & test imports. Corrected independent tests & `collate_fn` for empty batch. All `Dataset` tests pass.                                       |
| May 24      | MS1.2: Probe Models & Loss Fns          | `NameError` (Optional), `fixture 'self'` error in tests. Mismatch in independent loss test normalization. | Imported `Optional`. Fixed test fns. Corrected independent loss test to match H&M $L^2$ normalization. All model/loss tests pass.                               |
| May 24-26   | MS1.3 (Utils): Evaluate & Train Utils   | `NameError`s (`total_sentences`, `upos_full`), `IndentationError` in `evaluate.py`. `AttributeError` in `EarlyStopper` test. Optimizer LR check in checkpoint test. Spearman test logic refinement. | Fixed variable scoping & indentation. Corrected `EarlyStopper` property. Updated optimizer LR test assertion. Refined `calculate_spearmanr` to match H&M. All utility tests pass. |
| May 26      | MS1.3 (Main Script): `train_probe.py`   | Initial Hydra config composition error (`dataset@experiment.dataset`). `AssertionError` with `whykay-01` HDF5s & modern `conllu_reader`. Smoke test output path issues, checkpoint filename. | Resolved Hydra config by ensuring `experiment/*.yaml` pointed to self-generated HDF5s. Fixed smoke test output path logic & checkpoint naming. Implemented training script. |
| May 26      | **MS1.4: Full Validation (ELMo Sample)**| -                                                                                             | Successfully ran modern `train_probe.py` for distance & depth probes on self-generated ELMo sample using MPS. Achieved plausible metrics.        |
| May 26      | **Phase 1, MS1.3 (Main Script): `train_probe.py` Implementation**              | Initial Hydra config error (`dataset@experiment.dataset`). `AssertionError` with `whykay-01` HDF5s & modern `conllu_reader`. `UnboundLocalError` in training script. Output path issues & checkpoint naming in smoke test. | Resolved Hydra config. Switched modern probe to use self-generated ELMo HDF5s. Fixed `best_dev_metric_value_for_checkpointing` init. Corrected smoke test output path logic & checkpoint naming. Implemented H&M-style optimizer reset and LR decay (`LRSchedulerWithOptimizerReset`). |
| May 26      | **Phase 1, MS1.4: Full Validation on ELMo Sample (Modern Probe)**              | -                                                                                                                                                            | Successfully ran `train_probe.py` for both distance & depth probes on self-generated ELMo sample data using MPS. H&M LR decay/optimizer reset verified. Achieved plausible metrics. **Phase 1 COMPLETE.** |

(This history will be appended as the project progresses.)