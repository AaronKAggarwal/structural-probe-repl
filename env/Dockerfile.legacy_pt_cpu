# env/Dockerfile.legacy_pt_cpu

# 1. Base Image: Official Python 3.7 slim image for linux/amd64
FROM python:3.7-slim-buster

# 2. Set metadata labels
LABEL maintainer="<Aaron Aggarwal>"
LABEL project="structural-probe-repl"
LABEL description="Environment for running original Hewitt & Manning (2019) structural-probes code (PyTorch-based)"

# 3. Set working directory
WORKDIR /app/structural_probe_original

# 4. Install system dependencies (e.g., build-essential for Cython if needed, git for AllenNLP from git if necessary)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    && rm -rf /var/lib/apt/lists/*

# 5. Install Python dependencies
# Upgrade pip. Then install PyTorch (CPU version), AllenNLP, and other requirements.
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
    # Install PyTorch 1.1.0 (CPU) for Python 3.7 - find the correct wheel URL or pip command
    # The command below is how PyTorch.org recommends installing older versions
    # For PyTorch 1.1.0, Python 3.7, CPU on Linux:
    torch==1.3.0+cpu -f https://download.pytorch.org/whl/torch_stable.html \
    torchvision==0.4.1+cpu -f https://download.pytorch.org/whl/torch_stable.html \
    # AllenNLP 0.9.0
    allennlp==0.9.0 \
    # Specific pins based on previous research and LLM findings
    numpy==1.19.5        
    # Compatible with PT 1.1 and AllenNLP 0.9.0
    scipy==1.5.4          
    # Compatible
    scikit-learn==0.23.2 \
    nltk==3.5 \
    protobuf==3.20.1 \
    tqdm==4.47.0          `# For Py3.7 compatibility` \
    pytorch-pretrained-bert==0.6.2 \
    PyYAML==3.13 \
    # Requirements from Hewitt & Manning's requirements.txt (some are covered above)
    Cython \
    seaborn \
    h5py

# 6. Copy the original Hewitt & Manning code into the container
#    The COPY source is relative to the build context (your project root)
#    The COPY destination is relative to the WORKDIR if not absolute.
#    Since WORKDIR is now /app/structural_probe_original, and we want the code
#    to be *at* this location, we copy to '.' (current WORKDIR).
COPY src/legacy/structural_probe/. .

# 7. Copy helper scripts into a known location, e.g., /scripts_project_level
#    Or, keep them relative to the new WORKDIR if that makes sense.
#    Let's put them in a top-level /scripts directory in the image for clarity.
COPY scripts/check_legacy_env.sh /scripts/check_legacy_env.sh
COPY scripts/run_legacy_probe.sh /scripts/run_legacy_probe.sh
RUN chmod +x /scripts/check_legacy_env.sh /scripts/run_legacy_probe.sh

# 8. Set PYTHONPATH
ENV PYTHONPATH="/app/structural_probe_original:${PYTHONPATH}"

# 9. Define Entrypoint and Default Command (paths need to be absolute now)
ENTRYPOINT ["/scripts/check_legacy_env.sh"]
# Pass the config file path as the first argument to run_legacy_probe.sh
CMD ["/scripts/run_legacy_probe.sh", "example/config/prd_en_ewt-ud-sample.yaml"]